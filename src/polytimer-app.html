<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="./polytimer-timer.html">
<link rel="import" href="./polytimer-app-styles.html">

<dom-module id="polytimer-app">
  <template>
    <style is="custom-style" include="polytimer-app-styles"></style>
        
    <!--Display label-->
    <div id="timer-display">
      <polytimer-timer minutes={{currentTime}} id="timer"></polytimer-timer>
    </div>
    
    <!--Slider value-->
    <div class="slide-wrapper">
      <paper-slider 
        id="slider"
        value="{{value}}"
        max="60"
        min="1"        
        >
      </paper-slider>
    </div>

    <paper-button id="reset" disapear on-tap="resetHandler">
      <iron-icon icon="av:replay"></iron-icon>
    </paper-button>

    <!--Action button-->
    <paper-fab id="play"  elevation="0" on-tap="playHandler" icon="av:play-arrow"></paper-fab>
    <paper-fab id="pause" elevation="0" on-tap="pauseHandler" icon="av:pause" disapear></paper-fab>    
  
    <!--Service Worker toasts-->
    <!--
      TODO: Componentizar isso!
    -->

    <paper-toast 
      text="" 
      id="serviceWorkerFeedbackToast">
    </paper-toast>

    <paper-toast 
      id="serviceWorkerUpdateAviableToast" 
      duration="0"
      text="Update aviable!">
      <paper-button on-tap="_toastReloadApp">install</paper-button>
    </paper-toast>

  </template>

  <script>
    Polymer({
      is: 'polytimer-app',

      properties:{
        currentTime:{
          type: Number,
        },
        
        serviceWorkerState:{
          type: String,
          notify: true,
          observer: '_serviceWorkerStateChanged'
        },
      },

      listeners: {
        'immediate-value-change': 'immediateValueChangeHandler',
        'timerStarted': 'hideSlider',
        'change': 'changeHandler',
        'timerReseted': 'resetEventHandler'
      },

      playHandler: function(){
        if(this.$.timer.paused === true){
          this.$.timer.resume(this.$.timer.minutes, this.$.timer.seconds);
          this.$.play.setAttribute('disapear', '');
          this.$.pause.removeAttribute('disapear');
          this.$.reset.setAttribute('disapear', '');          
        } else {
          this.$.timer.start();
          this.$.play.setAttribute('disapear', '');
          this.$.pause.removeAttribute('disapear');   
        }           
      },
      pauseHandler: function(){
        this.$.timer.pause();

        this.$.pause.setAttribute('disapear', '');
        this.$.reset.removeAttribute('disapear');
        this.$.play.removeAttribute('disapear');              
                      
      },
      resetHandler:function(){
        this.$.timer.reset(this.$.slider.value);
      },
      hideSlider: function(){
        this.$.slider.setAttribute('disapear', '');
      },

      resetEventHandler:function(){
        this.$.reset.setAttribute('disapear', '');
        this.$.pause.setAttribute('disapear', '');
        this.$.slider.removeAttribute('disapear', '');
        this.$.slider.removeAttribute('disapear', '');                                                        
      },
      //Updates the value on change of the slider while user is interacting      
      immediateValueChangeHandler: function (e) {
        var value = this.$.slider.immediateValue;
        this.currentTime = value;                
      },
      //Updates the value on change of the slider right before user interaction
      changeHandler: function (e) {
        var value = this.$.slider.value;
        this.currentTime = value;
      },
      //Treats the service worker status change        
      _serviceWorkerStateChanged: function(newServiceWorkerState){
        if(newServiceWorkerState === 'installed'){
            this.$.serviceWorkerFeedbackToast.text = 'cache done! ready to go off-line';                      
            this.$.serviceWorkerFeedbackToast.opened = true;          
        } else if (newServiceWorkerState === 'update' || newServiceWorkerState === 'updated' || newServiceWorkerState === 'waiting'){
            this.$.serviceWorkerUpdateAviableToast.opened = true;            
        } else if(newServiceWorkerState === 'error'){
            this.$.serviceWorkerFeedbackToast.text = 'something went wrong =(';                      
            this.$.serviceWorkerFeedbackToast.opened = true;                
        } else {
          return
        }
      },
      //Reload the page if user clicked on a update toast
      _toastReloadApp: function(){
        this.$.serviceWorkerUpdateAviableToast.toggle();
        location.reload();
      },
    });
  </script>
</dom-module>
